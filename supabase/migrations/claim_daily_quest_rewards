
DECLARE
    total_reward DECIMAL(10,4) := 0;
    quest_count INTEGER := 0;
BEGIN
    -- Check if all today's quests are completed
    SELECT COUNT(*), COALESCE(SUM(reward_amount), 0)
    INTO quest_count, total_reward
    FROM user_daily_quests
    WHERE user_id = p_user_id
        AND assigned_date = CURRENT_DATE
        AND is_completed = TRUE;

    -- Must complete all 3 quests
    IF quest_count < 3 THEN
        RAISE EXCEPTION 'Must complete all daily quests before claiming rewards';
    END IF;

    -- Check if already claimed today
    IF EXISTS (
        SELECT 1 FROM quest_completion_history
        WHERE user_id = p_user_id AND completion_date = CURRENT_DATE
    ) THEN
        RAISE EXCEPTION 'Daily quest rewards already claimed today';
    END IF;

    -- Update user's ITLOG balance
    UPDATE profiles 
    SET itlog_tokens = itlog_tokens + total_reward,
        updated_at = NOW()
    WHERE user_id = p_user_id;

    -- Record completion
    INSERT INTO quest_completion_history (
        user_id, 
        completion_date, 
        total_reward, 
        quests_completed
    ) VALUES (
        p_user_id, 
        CURRENT_DATE, 
        total_reward, 
        quest_count
    );

    RETURN total_reward;
END;
